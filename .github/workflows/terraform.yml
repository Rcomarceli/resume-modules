name: "Terraform"

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  startup:
    permissions: write-all
    # name: print-token
    # environment: dev
    # needs: pre-pkr
    name: "Terraform"
    runs-on: ubuntu-latest
    # defaults:
    #   run:
    #     working-directory: ./dev
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # - name: Setup Terraform
      #   uses: hashicorp/setup-terraform@v1
      #   with:
      #     # terraform_version: 0.13.0:
      #     cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      # - name: Configure AWS Credentials
      #   uses: aws-actions/configure-aws-credentials@v1
      #   with:
      #     aws-region: us-east-1
      #     role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
      #     role-session-name: OIDCSession

      - name: Cache plugin dir
        uses: actions/cache@v3
        with:
          path: ~/.tflint.d/plugins
          key: ${{ matrix.os }}-tflint-${{ hashFiles('.tflint.hcl') }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v3
        with:
          tflint_version: latest
          # tflint_version: v0.44.1

      - name: Load Tflint Config
        uses: terraform-linters/tflint-load-config-action@v1
        with:
          source-repo: Rcomarceli/tflint-config
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show version
        run: tflint --version

      - name: Init TFLint
        run: tflint --init

  tests:
    name: Run Tests
    needs: startup
    steps:
      - name: Run TFLint
        run: tflint -f compact --recursive
        
      - name: Terraform Format
        id: fmt
        run: terraform fmt -check -recursive

      - name: Terraform Init
        id: init
        run: terraform -chdir=tests/valid init -backend=false
      
      - name: Terraform Validate
        id: validate
        run: terraform -chdir=tests/valid validate -no-color

